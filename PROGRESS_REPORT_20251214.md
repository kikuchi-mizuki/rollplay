# 進捗レポート - 2025年12月14日（セッション4）

## 📊 セッション概要

**日時**: 2025年12月14日 00:00-02:00
**作業時間**: 約2時間
**実施作業**: レイテンシー修正、AIの応答改善、キャッシュクリア機能、会話中リロード問題、ショート動画制作会社設定

---

## 🔧 問題1: レイテンシー計算の異常値

### 症状

```
[latency] whisper→gpt_first_token: -1765586920344ms  ❌ 異常
[latency] total (speech_end→tts_play): -1765586920342ms  ❌ 異常
```

負の値で約-204万日相当という異常な値が表示される。

### 原因分析

**ファイル**: `src/RoleplayApp.tsx`

```typescript
// ❌ 間違い
console.log(`[latency] whisper→gpt_first_token: ${(t2 - (performance.timeOrigin + t0)).toFixed(0)}ms`);
```

`performance.timeOrigin`（1970年からのミリ秒）と`t0`（ページ読み込みからの経過時間）を誤って組み合わせていた。

### 修正内容

#### 修正1: 関数の引数に`t1`を追加

```typescript
// handleSendStreamの引数を修正
const handleSendStream = async (text: string, vadMode: boolean, t0?: number, t1?: number) => {
  let t2: number | undefined; // GPT最初のトークン受信時刻を保存
```

#### 修正2: レイテンシー計算式を修正

```typescript
// ✅ 正しい計算式
console.log(`[latency] whisper→gpt_first_token: ${(t2 - t1).toFixed(0)}ms`);
console.log(`[latency] total (speech_end→tts_play): ${(t3 - t0).toFixed(0)}ms`);
console.log(`[latency] gpt_first_token→tts_play: ${(t3 - t2).toFixed(0)}ms`);
```

### 結果

**修正前**:
```
[latency] whisper→gpt_first_token: -1765586920344ms  ❌
```

**修正後**:
```
[latency] whisper→gpt_first_token: 3441ms  ✅
[latency] total (speech_end→tts_play): 5112ms  ✅
[latency] gpt_first_token→tts_play: 2ms  ✅
```

**デプロイ**: commit c54ee6f

---

## 🎯 問題2: AIが聞かれていないことまで話してしまう

### ユーザーからの要望

「こちらが聞いてないのにAIが色々話しますが、営業が質問したことに自然に答えて欲しいです」

### 問題点

**修正前の応答例**:
```
営業: 「現在のSNS運用状況を教えてください」
AI: 「InstagramとTikTokをやってるんですけど、Instagramはフォロワー1,200人くらいで
     週2-3回は投稿してるんですよ。でも「いいね」が20-30くらいしか付かなくて...。
     TikTokは正直よく分からなくて、スタッフに任せてるんですけど全然伸びないんです。
     他のサロンさんがリール動画で集客成功してるって聞いて、うちもやらないとって焦ってます。
     どんなことができるのか、教えてもらえますか？」
```

❌ 問題点：
- 聞かれていない詳細まで一度に話す
- 自分から質問を返してしまう
- 営業が深掘りする余地がない

### 修正内容

**ファイル**: `scenarios/meeting_1st.json`

#### 修正1: ガイドラインを簡潔に

```json
"guidelines": [
  "営業の質問に対しては、聞かれたことだけを1-2文で簡潔に答える（30-80文字程度）",
  "情報は小出しにして、営業が深掘りしたら詳しく話す（営業主導の会話を心がける）",
  "過去の経験や失敗談は、営業が聞いてきた時だけ話す（自分からは話さない）",
  "自分から質問を返すのは控える（営業が話を進めるのを待つ姿勢）"
]
```

#### 修正2: サンプル応答を簡潔に

```json
{
  "speaker": "お客様",
  "text": "InstagramとTikTokをやってるんですけど、正直あまり上手くいってなくて..."
}
```

### 結果

**修正後の期待される応答**:
```
営業: 「現在のSNS運用状況を教えてください」
AI: 「InstagramとTikTokをやってるんですけど、正直あまり上手くいってなくて...」
```

✅ 改善点：
- 聞かれたことだけを簡潔に答える
- 営業が「どんな風に上手くいってないんですか？」と深掘りできる
- 営業主導で会話が進む

**デプロイ**: commit a1a5691

---

## 🛠️ 問題3: バックエンドのキャッシュ問題

### 症状

GitHubにプロンプト修正をプッシュしても、サーバー再起動まで反映されない。

### 原因

**ファイル**: `app.py`

```python
def load_scenario_object(scenario_id: str):
    if scenario_id in SCENARIO_CACHE:
        return SCENARIO_CACHE[scenario_id]  # ← 古いシナリオが返される
```

サーバー起動後、シナリオファイルを一度読み込むとメモリにキャッシュされ、再起動するまで更新されない。

### 修正内容

#### 追加したエンドポイント

**ファイル**: `app.py:466-483`

```python
@app.route('/api/clear-cache', methods=['POST'])
def clear_cache():
    """シナリオキャッシュをクリア（開発用）"""
    global SCENARIO_CACHE
    cache_size = len(SCENARIO_CACHE)
    SCENARIO_CACHE.clear()
    print(f"✅ シナリオキャッシュをクリアしました（{cache_size}件）")
    return jsonify({
        'success': True,
        'message': f'キャッシュをクリアしました（{cache_size}件）'
    })
```

### 使用方法

ブラウザコンソールで実行：

```javascript
fetch('/api/clear-cache', { method: 'POST' })
  .then(r => r.json())
  .then(console.log)
```

**デプロイ**: commit c2cf505

---

## 🎭 問題4: 文脈に応じた自然なトーン変化

### ユーザーからの要望

「AIの話し方、文脈を見て自然なトーンで話せないですか？」

### 修正内容

**ファイル**: `scenarios/meeting_1st.json`

#### 追加したガイドライン

```json
"guidelines": [
  "【重要】会話の流れと営業の対応に応じて、トーンと態度を自然に変化させる：",
  "  - 最初（1-2往復）：警戒心があり、短く答える。様子見の姿勢（「そうですね...」「まあ、そうなんですけど...」）",
  "  - 営業が共感的な質問やオープンクエスチョンをしたら：徐々に心を開き、詳しく話す（「実は...」「本当に困ってて...」）",
  "  - 営業が押し売りや一方的な提案をしたら：距離を置き、慎重な態度になる（「うーん...」「ちょっと考えさせてください」）",
  "  - 営業が自分の悩みを理解してくれたら：安心して、より具体的な課題を話す（「そうなんですよ！」「分かってもらえて嬉しいです」）",
  "  - 会話が進み信頼関係ができたら（3-4往復以降）：打ち解けて、自分から補足情報を話すこともある"
]
```

### 期待される効果

✅ **営業の質問力が評価される**
- 良い質問（オープンクエスチョン、共感）→ AIが詳しく話す
- 悪い質問（クローズドクエスチョン、押し売り）→ AIが警戒する

✅ **よりリアルな商談体験**
- 実際の顧客のように、営業の対応次第で態度が変わる

**デプロイ**: commit 1e60237

---

## 🔄 問題5: 会話中に画面がリロードされてしまう

### 症状

ログから：
```
❌ Profile fetch error: プロフィール取得タイムアウト
❌ リトライ上限に達しました
📋 登録画面: ユーザー情報取得開始
✅ 登録画面: プロフィール既存 → メイン画面へ
```

会話中に画面がリロードされ、会話が中断される。

### 原因分析

1. 会話中にSupabaseのプロフィール取得がタイムアウト
2. AuthContextが`profile`を`null`に設定
3. ProtectedRouteが`!profile`を検出し、`/register`にリダイレクト
4. RegisterPageが`/`に戻る
5. ユーザーには「リロード」に見える

### 修正内容

**ファイル**: `src/contexts/AuthContext.tsx:95-121`

#### Before（修正前）

```typescript
} catch (err: any) {
  if (err.message === 'プロフィール取得タイムアウト') {
    // リトライ処理...
  }

  setProfile(null)  // ← 既存のプロフィールが消える
}
```

#### After（修正後）

```typescript
} catch (err: any) {
  if (err.message === 'プロフィール取得タイムアウト') {
    // リトライ処理...

    console.warn('⚠️  既存のプロフィールを保持します（会話を継続できます）')
    return  // ← setProfile(null)を呼ばない
  }

  setProfile(null)  // タイムアウト以外のエラーの場合のみ
}
```

### 結果

✅ **会話が中断されない**
- Supabaseがタイムアウトしても、既存のプロフィールが保持される
- リダイレクトが発生しない
- 会話を継続できる

**デプロイ**: commit d84f83e

---

## 🎬 問題6: ショート動画制作会社の設定を明確化

### ユーザーからの要望

1. 「このロープレはショート動画の制作会社です。その設定になっていますか？」
2. 「過去のロープレの音声を学習させていると思いますので、よりその内容に近づけるように調整してください」

### 実施した調査

#### RAGデータの分析

**ファイル**: `rag_index/sales_patterns.json`

実際のロープレ音声データから：
- **会社名**: 「ショート動画屋さん」
- **サービス内容**: InstagramリールやTikTok用の縦型ショート動画制作、月間15〜20本
- **対応業種**: クリーニング会社、美容サロン、レストラン、SaaS企業など
- **営業トーク**: 「ちなみに〜してらっしゃいますか」などの丁寧な表現、月間本数の話題

### 修正内容

**ファイル**: `app.py:332-418`

#### 修正1: 会社設定を明確化

```python
【営業担当について】
営業担当は「ショート動画制作会社（ショート動画屋さん）」の社員です。
InstagramリールやTikTok用の縦型ショート動画を月間15〜20本制作・運用代行するサービスを提供しています。
クリーニング会社、美容サロン、レストラン、SaaS企業など多様な業種に対応しています。
```

#### 修正2: 顧客の悩みを具体化

```python
自社でショート動画を作ろうとしているが、なかなか本数がスケールしない。
月に数本は作れるけど、もっと増やしたい。
または、外注しているけどコストや品質に課題がある。
```

#### 修正3: 会話例を実際のRAGデータに基づいて改善

```python
営業: ちなみに今はショート動画は作られてらっしゃいますか？
あなた: そうですね、自社で結構作ってて...でもなかなか本数スケールしないんですよ。

営業: 今はちなみに月間何本ぐらい作られてらっしゃいますか？
あなた: うーん、今弊社が繁忙期と閑散期みたいな感じで結構強く分かれるんですけど、
        繁忙期だと大体15本とか20本は社内で作ってて...
        それに余る分は外注に頼んでるって感じですね。
```

### 結果

✅ **会社の設定が明確に**
- 「ショート動画屋さん」であることが分かる
- 月間15〜20本制作という具体的なサービス内容

✅ **実際のロープレに近い会話**
- 実際のRAGデータに学習された会話パターンに近づく

**デプロイ**: commit 45d2d93

---

## 📦 デプロイ履歴

### コミット1: レイテンシー計算のバグ修正

```bash
commit c54ee6f
fix: レイテンシー計算のバグを修正
```

### コミット2: AIの応答を簡潔に

```bash
commit a1a5691
fix: AIの応答を簡潔にして営業主導の会話に改善
```

### コミット3: キャッシュクリア機能追加

```bash
commit c2cf505
feat: シナリオキャッシュクリア機能を追加（開発用）
```

### コミット4: 文脈に応じたトーン変化

```bash
commit 1e60237
feat: 文脈に応じた自然なトーン変化を追加
```

### コミット5: 会話中のリロード問題修正

```bash
commit d84f83e
fix: 会話中のリロード問題を修正
```

### コミット6: ショート動画制作会社設定の明確化

```bash
commit 45d2d93
feat: ショート動画制作会社の設定を明確化し、実際のロープレデータに基づいて調整
```

---

## ✅ 完了した作業

### 技術的な修正

- [x] レイテンシー計算のバグを修正（正常な値を表示）
- [x] AIの応答を簡潔に改善（営業主導の会話）
- [x] バックエンドのキャッシュクリア機能を追加
- [x] 文脈に応じた自然なトーン変化を実装
- [x] 会話中のリロード問題を修正（Supabaseタイムアウト時も継続）
- [x] ショート動画制作会社の設定を明確化
- [x] 実際のRAGデータに基づいて会話例を改善

### 今後の課題として議論したトピック

- [ ] ElevenLabsへの移行（感情豊かな音声）→ コスト約15倍
- [ ] OpenAI TTSの声質変更（nova → shimmer / fable）

---

## 🎯 次のステップ（推奨）

### 1. ユーザーテスト

- AIの応答が簡潔になったか確認
- 文脈に応じたトーン変化が自然か確認
- ショート動画制作会社の設定が反映されているか確認
- 会話中のリロードが解消されているか確認

### 2. さらなる調整（必要に応じて）

- **声質の変更**: voice="nova" → "shimmer"（より柔らかい声）
- **ElevenLabsのテスト**: 無料プラン（10,000文字）で試す
- **RAGデータの追加**: さらに多くの実際のロープレデータを学習

### 3. 他のシナリオへの適用

- 2次面談、3次面談のシナリオにも同じ改善を適用
- 各シナリオの特性に合わせたガイドラインを追加

---

## 📊 パフォーマンス指標

### 修正前の問題

- レイテンシー計算が異常値（-1765586920344ms）
- AIが聞かれていないことまで一度に話す
- シナリオ変更がサーバー再起動まで反映されない
- 会話中に画面がリロードされる
- ショート動画制作会社の設定が曖昧

### 修正後の期待

- レイテンシー計算が正常値（3000〜5000ms程度）
- AIが簡潔に答え、営業主導の会話が可能
- キャッシュクリアで即座に反映
- 文脈に応じてトーンが自然に変化
- 会話中のリロードが解消
- ショート動画制作会社の設定が明確

---

## 💡 技術的な学び

### 1. TypeScriptのタイムスタンプ計算

- `performance.timeOrigin`: Unixエポックタイムスタンプ（1970年からのミリ秒）
- `performance.now()`: ページ読み込みからの経過時間
- これらを混在させると異常な値になる

### 2. プロンプトエンジニアリング

- 情報量を減らすことで営業主導の会話を実現
- 文脈に応じた動的な指示でリアルな会話が可能
- 実際のRAGデータに基づくことで自然な会話に

### 3. キャッシュ管理

- 開発用のキャッシュクリア機能は必須
- サーバー再起動なしで即座に反映可能

### 4. エラーハンドリング

- タイムアウトエラー時は既存の状態を保持する
- ユーザー体験を優先した設計

---

## 📝 まとめ

本セッションでは、以下の6つの大きな問題を解決しました：

1. **レイテンシー計算のバグ** → 正常な値を表示
2. **AIの応答改善** → 簡潔で営業主導の会話
3. **キャッシュクリア機能** → 即座に反映
4. **文脈に応じたトーン変化** → リアルな会話
5. **会話中のリロード問題** → 継続可能に
6. **ショート動画制作会社設定** → 明確化とRAGデータ活用

特に、実際のロープレ音声データ（RAG）を分析して、「ショート動画屋さん」の設定と会話スタイルを反映させたことで、よりリアルな商談体験を実現しました。

次回のセッションでは、ユーザーテストの結果を元に、さらなる微調整を行う予定です。

---

**作成日時**: 2025年12月14日 02:00
**作成者**: Claude Code
**次回セッション**: TBD
