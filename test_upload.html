<!DOCTYPE html>
<html>
<head>
  <title>Supabase Upload Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Supabase Avatar Upload Test</h1>

  <input type="file" id="fileInput" accept="image/*">
  <button onclick="testUpload()">Test Upload</button>

  <div id="result" style="margin-top: 20px; padding: 10px; background: #f0f0f0;"></div>

  <script>
    const SUPABASE_URL = 'https://guargnhnblhiupjumkhe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1YXJnbmhuYmxoaXVwanVta2hlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NjAxMTIsImV4cCI6MjA3ODMzNjExMn0.UYmflAhojEj_N_tGei_L4DgqSrTMPCVtWbiQQ8DQTMM';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function log(message, isError = false) {
      const result = document.getElementById('result');
      const color = isError ? 'red' : 'green';
      result.innerHTML += `<div style="color: ${color};">${message}</div>`;
      console.log(message);
    }

    async function testUpload() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        log('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', true);
        return;
      }

      document.getElementById('result').innerHTML = '';

      log(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:`);
      log(`- åå‰: ${file.name}`);
      log(`- ã‚¿ã‚¤ãƒ—: ${file.type}`);
      log(`- ã‚µã‚¤ã‚º: ${file.size} bytes`);
      log('');

      // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
      const fileExt = file.name.split('.').pop()?.toLowerCase() || 'png';
      const uniqueId = `${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
      const fileName = `avatar_${uniqueId}.${fileExt}`;

      log(`ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å: ${fileName}`);
      log('');

      // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
      const { data: { session } } = await supabase.auth.getSession();
      log(`ğŸ” èªè¨¼çŠ¶æ…‹: ${session ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³'}`);

      if (!session) {
        log('âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚¢ãƒ—ãƒªã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', true);
        return;
      }

      log('');
      log('ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹...');

      try {
        const { data, error } = await supabase.storage
          .from('avatars')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: false
          });

        if (error) {
          log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
          log(`è©³ç´°: ${JSON.stringify(error, null, 2)}`, true);
          return;
        }

        log(`âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ!`);
        log(`ãƒ‘ã‚¹: ${data.path}`);

        // å…¬é–‹URLã‚’å–å¾—
        const { data: { publicUrl } } = supabase.storage
          .from('avatars')
          .getPublicUrl(data.path);

        log(`ğŸŒ å…¬é–‹URL: ${publicUrl}`);
        log('');
        log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸï¼ğŸ‰');

      } catch (error) {
        log(`âŒ ä¾‹å¤–ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
        console.error(error);
      }
    }
  </script>
</body>
</html>
