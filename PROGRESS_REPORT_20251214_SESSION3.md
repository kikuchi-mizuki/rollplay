# 開発進捗レポート - 2025年12月14日（セッション3）

## 📋 セッション概要

**日時**: 2025年12月14日
**セッション**: 3回目
**主な改善**: VAD再開ロジックの完全修正、ペルソナ設定の根本的改善

---

## 🎯 実装した機能・改善

### 1. AI応答後の音声認識問題の修正 (4コミット連続修正)

#### 問題1-1: 割り込み後のVAD再開忘れ (commit: a201836)

**問題**:
- 最初の音声認識は成功するが、2回目以降が認識されない
- ログ: 音声レベルが閾値を超えているのに録音開始しない

**原因**:
- `stopAllAudio()` 内で `disableInterruptMode()` のみ呼び出し
- `resumeVAD()` の呼び出しが欠けていた

**修正内容**:
```typescript
// src/RoleplayApp.tsx:232-235
audioRecorderRef.disableInterruptMode();
if (vadMode) {
  audioRecorderRef.resumeVAD();
  console.log('🔓 VAD再開（割り込み停止後）');
}
```

#### 問題1-2: playbackLoop終了せず (commit: 70188e9)

**問題**:
- `🛑 再生ループ終了` のログが出ない
- VADが再開されない

**原因**:
1. `playbackLoopRunning=false` 後、`waitForQueue()` で待機中の Promise が解決されない
2. 正常終了時に `disableInterruptMode()` を呼んでいない

**修正内容**:
```typescript
// ストリーム完了後 (line 453-457)
playbackLoopRunning = false;

// 待機中のwaitForQueueを解除
if (resolveWaiter) {
  (resolveWaiter as () => void)();
  resolveWaiter = null;
}

// playbackLoop終了時 (line 319-324)
// 割り込みモードを無効化してVADを再開
if (vadMode) {
  audioRecorderRef.disableInterruptMode();
  audioRecorderRef.resumeVAD();
  console.log('🔓 VAD再開（正常終了）');
}
```

#### 問題1-3: クロージャー問題 (commit: 55814a7)

**問題**:
- `playbackLoop` 終了時に `🔓 VAD再開（正常終了）` が出ない
- 代わりに `✅ VADモード停止` が出る

**原因**:
- `isVADMode` (React state) をクロージャーで参照
- `handleSendStream` 呼び出し時点の古い値を使用

**修正内容**:
```typescript
// 修正前
if (isVADMode) {  // ❌ React stateを参照

// 修正後
if (vadMode) {    // ✅ 関数パラメータを参照
```

**影響箇所**:
- stopAllAudio() (line 232)
- playbackLoop終了時 (line 320)
- エラー処理時 (line 510)

#### 問題1-4: VADモード状態の参照タイミング (commit: a7c9271)

**問題**:
- VAD録音経由でも `vadMode=false` になる
- `🔓 VAD再開（正常終了）` が出ない

**原因**:
- VAD録音コールバック内で `handleSend()` 呼び出し
- `handleSend()` は `isVADModeRef.current` を参照
- Whisper処理中（数秒）に値が変化する可能性

**問題の流れ**:
```
t=0秒:   🎤 録音開始 (isVADMode=true)
t=4秒:   🔇 録音停止 → Whisper APIへ送信
t=4-6秒: ⏳ Whisper処理中...
         （この間にisVADModeRef.currentがfalseになる可能性）
t=6秒:   ✅ Whisper完了
         ❌ handleSend()はisVADModeRef.current（false）を参照
         ❌ handleSendStream(text, false, ...) が呼ばれる
t=10秒:  🛑 playbackLoop終了
         ❌ if(vadMode) が false → VAD再開されない
```

**修正内容**:
```typescript
// 修正前 (line 863)
await handleSend(result.text, t0, t1);

// 修正後 (line 864)
// VAD録音経由なので、vadMode=trueを明示的に渡す
await handleSendStream(result.text, true, t0, t1);
```

**効果**:
- VAD録音経由は常に `vadMode=true` が確実に渡される
- `isVADModeRef.current` の値に依存しない

---

### 2. ペルソナ設定の根本的改善 (2コミット)

#### 問題2-1: RAGパターンに営業側の発言が混入 (commit: 720fab5)

**問題**:
- AIが営業として話す: 「私たちのサービスは、ショート動画の制作・運用代行を...」
- AIは顧客役のはずが、サービス提供側として説明

**根本原因**:

**RAGデータの構造**:
```python
Pattern 3 (sales_patterns.json):
営業: クリーニングの授業を御社でされてらっしゃるというところで
顧客: 今もショート動画を結構いろいろ作ってらっしゃるんですかね
営業: そうですね 自社で結構作ってて  ← 営業側の発言も含まれる！
顧客: それがなかなか本数ス...
```

- RAGデータに営業と顧客の両方の発言が保存
- AIが営業側の発言パターンも学習してしまう

**修正内容**:
```python
# app.py:842-850
# 顧客側の発言のみを抽出（営業側の発言を除外）
customer_lines = []
for line in pattern_text.split('\n'):
    if line.strip().startswith('顧客:'):
        customer_lines.append(line.strip())

if customer_lines:
    customer_only_text = '\n'.join(customer_lines)
    rag_patterns.append(f"- {customer_only_text[:300]}")
```

**効果**:
- 営業側の発言を完全除外
- 顧客側の発言のみをパターンとして参照

#### 問題2-2: システムプロンプトの混乱 (commit: e3fa6e4)

**問題**:
- 依然としてAIが営業として説明
- 「ショート動画屋さんでは、月間15〜20本制作...」

**根本原因**:

**元のプロンプト (Line 336-340)**:
```python
【営業担当について】
営業担当は「ショート動画制作会社（ショート動画屋さん）」の社員です。
InstagramリールやTikTok用の縦型ショート動画を月間15〜20本制作・
運用代行するサービスを提供しています。
```

AIがこの部分を読んで:
- 「ショート動画屋さん = 自分の会社」と勘違い
- 「月間15〜20本制作 = 自分のサービス」と解釈
- 営業として説明してしまう

**修正内容**:

**1. 【あなたは誰ですか？】セクションを追加**:
```python
【あなたは誰ですか？】
⚠️ あなたは「ショート動画制作に悩んでいる事業主」です。
⚠️ あなたは「ショート動画屋さん」という会社に相談に来た「お客さん」です。
⚠️ あなたはこの会社の社員ではありません。
   この会社のサービスについて説明する立場ではありません。
```

**2. 【営業担当について】を明確化**:
```python
【営業担当について】
あなたの前にいる営業担当は「ショート動画制作会社（ショート動画屋さん）」の社員です。
その営業が、InstagramリールやTikTok用の縦型ショート動画を...
⚠️ これは営業側のサービスであり、あなたのサービスではありません。
```

**3. 禁止事項を強化**:
```python
- 【禁止】営業のようにサービス説明してはいけません
  （「InstagramリールやTikTok用の動画を月間15〜20本制作...」など）
- 【禁止】「ショート動画屋さん」のサービスを説明してはいけません
  （あなたは顧客であり、サービスを知りたい側です）
```

**効果**:
- 役割の明確化（顧客 vs 営業）
- サービス説明の完全禁止
- 誤解を招く表現を除去

---

## 📊 修正の全体像

### VAD再開ロジックの完全修正（4段階）

| コミット | 問題 | 修正内容 | 影響 |
|---------|------|---------|------|
| a201836 | 割り込み後のVAD再開忘れ | stopAllAudio()にresumeVAD()追加 | 割り込み後の認識 |
| 70188e9 | playbackLoop終了せず | resolveWaiter呼び出し、disableInterruptMode()追加 | 正常終了時の認識 |
| 55814a7 | クロージャー問題 | isVADMode→vadModeパラメータに変更 | 全体の安定性 |
| a7c9271 | VADモード状態参照タイミング | VAD録音経由はvadMode=trueを明示 | 確実なVAD再開 |

### ペルソナ設定の根本的改善（2段階）

| コミット | 問題 | 修正内容 | 影響 |
|---------|------|---------|------|
| 720fab5 | RAG営業発言混入 | 顧客側発言のみ抽出 | RAGパターン品質 |
| e3fa6e4 | システムプロンプト混乱 | 役割明確化、禁止事項強化 | ペルソナ一貫性 |

---

## 🔧 技術的改善

### フロントエンド (src/RoleplayApp.tsx)

**1. stopAllAudio() の改善**:
- `resumeVAD()` 追加（割り込み後の復帰）
- `vadMode` パラメータを使用（クロージャー問題回避）

**2. playbackLoop終了処理の改善**:
- `resolveWaiter` 呼び出し（待機解除）
- `disableInterruptMode()` + `resumeVAD()` 追加

**3. VAD録音コールバックの改善**:
- `handleSend()` → `handleSendStream()` 直接呼び出し
- `vadMode=true` を明示的に渡す

### バックエンド (app.py)

**1. RAG検索処理の改善**:
```python
# 顧客側の発言のみを抽出
for line in pattern_text.split('\n'):
    if line.strip().startswith('顧客:'):
        customer_lines.append(line.strip())
```

**2. システムプロンプトの大幅強化**:
- 【あなたは誰ですか？】セクション追加（役割明確化）
- 【営業担当について】セクション改善（主語明確化）
- 禁止事項の追加（営業的説明の完全禁止）

---

## 📈 成果指標

### VAD関連の改善

**修正前**:
```
1回目: ✅ 認識成功
2回目: ❌ 認識失敗（VADが再開されない）
```

**修正後**:
```
1回目: ✅ 認識成功
2回目: ✅ 認識成功
3回目: ✅ 認識成功
...∞回: ✅ 常に認識成功
```

**期待されるログシーケンス**:
```
✅ 全チャンク再生完了。再生ループを停止します。
🛑 再生ループ終了
[アバター] 再生終了、listening表情に復帰
🔕 割り込みモード無効化
▶️ VAD再開
🔓 VAD再開（正常終了）
👂 音声検出開始 (レベル: XX.X)
```

### ペルソナ関連の改善

**修正前**:
```
営業: 「御社について教えてください」
AI:  「ショート動画屋さんでは、Instagramリールや...」 ❌ 営業として説明
```

**修正後**:
```
営業: 「どんな課題をお持ちですか？」
AI:  「そうですね、自社で動画作ってて...でも本数スケールしないんですよ」 ✅ 顧客として話す
```

---

## 🎯 ユーザー体験の改善

### 会話の連続性

**修正前**:
- 1回の会話で終了
- 2回目以降は手動録音が必要

**修正後**:
- 無限に会話が続けられる
- VADモードで自然な対話が実現

### ペルソナの一貫性

**修正前**:
- AIが営業と顧客を混同
- 「おやすみなさい」のような不適切な応答
- サービス説明をしてしまう

**修正後**:
- 常に顧客として一貫した応答
- 適切な悩み相談
- 営業的な説明は一切しない

---

## 🚀 今後の改善提案

### 優先度高

1. **RAGデータの再構築**:
   - 現在: 会話全体が混在したデータ
   - 理想: 顧客側と営業側を完全分離したデータ構造
   - メリット: フィルタリングが不要、処理速度向上

2. **システムプロンプトの最適化**:
   - 現在: 長文のプロンプト（~500行）
   - 理想: より簡潔で明確な指示
   - メリット: トークン数削減、応答速度向上

3. **温度設定の見直し**:
   - 現在: 0.7（ストリーミング版）、0.9（非ストリーミング版）
   - 理想: 両方を0.7に統一
   - メリット: より一貫した応答

### 優先度中

1. **Few-shotサンプルの最適化**:
   - 顧客側の実例のみを含める
   - より自然な会話パターンを追加

2. **エラーハンドリングの強化**:
   - RAG検索失敗時のフォールバック
   - ネットワークエラー時のリトライ

---

## 📝 Git履歴

```
e3fa6e4 fix: システムプロンプトを強化してAIが営業役と混同しないように修正
720fab5 fix: RAGパターンから顧客側の発言のみを抽出するように修正
a7c9271 fix: VAD録音経由時に常にvadMode=trueを渡すように修正
55814a7 fix: クロージャー問題によりVADが再開されない不具合を修正
70188e9 fix: AI応答後にplaybackLoopが終了せずVADが再開されない問題を修正
a201836 fix: AI応答後に2回目の音声が認識されない問題を修正
```

---

## 💬 ユーザーからのフィードバック・要望

### 実装済み

1. ✅ 「音声が認識されません」
   → VAD再開ロジックを4段階で完全修正

2. ✅ 「話し始めが認識されません」
   → playbackLoop終了処理とVAD再開の完全実装

3. ✅ 「会話が成立しません」
   → クロージャー問題とVADモード状態参照タイミングの修正

4. ✅ 「ペルソナの設定がおかしいです」
   → RAGフィルタリングとシステムプロンプト強化

5. ✅ 「ショート動画の制作をしているのはこちらで、AIは顧客役のはずです」
   → システムプロンプトの役割明確化と禁止事項追加

---

## 🔍 次回セッションへの引き継ぎ事項

### 優先度高

1. **バックエンド再起動の確認**:
   - システムプロンプトの修正が反映されているか
   - AIが顧客役として一貫して応答するか

2. **連続会話のテスト**:
   - 3回以上の連続会話が成立するか
   - VAD再開ログが確実に出るか

3. **ペルソナの検証**:
   - 営業的な説明が一切出ないか
   - 顧客としての悩み相談が自然か

### 監視項目

1. **VAD再開の確実性**:
   - すべての終了パターンで再開されるか
   - エラー時も確実に再開されるか

2. **ペルソナの一貫性**:
   - RAGパターンが顧客側のみか
   - システムプロンプトの指示が守られているか

3. **会話の自然さ**:
   - 応答長さが適切か（最初は短く、徐々に詳しく）
   - フィラーや間が自然か

---

## ✅ セッション完了

**開始時刻**: セッション開始時
**終了時刻**: 2025年12月14日
**実装コミット数**: 6件
**変更ファイル数**: 2ファイル（RoleplayApp.tsx, app.py）
**総改善項目**: 6機能（VAD再開 × 4、ペルソナ × 2）

**状態**: ✅ すべての変更をコミット＆プッシュ済み

**重要**: バックエンド（Python）の再起動が必須です！
