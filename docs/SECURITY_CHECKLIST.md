# セキュリティチェックリスト

本番環境デプロイ前に、以下のセキュリティ項目を確認してください。

## 環境変数の管理

### ✅ 必須項目

- [ ] `.env`ファイルが`.gitignore`に含まれている
- [ ] 本番環境の環境変数が安全に管理されている（Vercel/Railwayの環境変数設定）
- [ ] APIキーが平文でコードに含まれていない

### 🔑 重要な環境変数

```bash
# Supabase
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key  # 本番環境のみ

# OpenAI
OPENAI_API_KEY=your-openai-api-key

# D-ID (オプション)
D_ID_API_KEY=your-did-api-key
```

---

## Row Level Security (RLS)

### ✅ RLSポリシーの確認

- [ ] `profiles`テーブル: ユーザーは自分のプロフィールのみ閲覧・更新可能
- [ ] `conversations`テーブル: ユーザーは自分の会話のみ閲覧・作成可能
- [ ] `evaluations`テーブル: ユーザーは自分の評価のみ閲覧・作成可能
- [ ] `stores`テーブル: 全ユーザー閲覧可、本部管理者のみ編集可
- [ ] `video_cache`テーブル: 全ユーザー閲覧可（共有リソース）

### ⚠️ 循環参照の排除

- [ ] 管理者ポリシーがprofilesテーブルを参照していない
- [ ] `06_fix_rls_circular_reference.sql`が実行済み

---

## 認証とアクセス制御

### ✅ Google OAuth

- [ ] Supabaseで正しいリダイレクトURLが設定されている
  - 本番: `https://your-domain.vercel.app/auth/callback`
  - 開発: `http://localhost:5173/auth/callback`
- [ ] Google Cloud Consoleで承認済みリダイレクトURIが設定されている

### ✅ ロール管理

- [ ] `admin`: 本部管理者（全データアクセス可能）
- [ ] `manager`: 店舗管理者（自店舗データのみ）
- [ ] `user`: 一般ユーザー（自分のデータのみ）

---

## データ保護

### ✅ 個人情報

- [ ] ユーザーのメールアドレスが適切に保護されている
- [ ] プロフィール情報が不要に公開されていない
- [ ] 会話履歴が他のユーザーに見られない

### ✅ データ保存

- [ ] Supabase Storageのアクセス権限が適切に設定されている
- [ ] 動画キャッシュが適切に保護されている
- [ ] センシティブなログ出力がない（APIキー、パスワード等）

---

## API セキュリティ

### ✅ レート制限

- [ ] OpenAI API: 適切なタイムアウト設定（現在: 120秒）
- [ ] D-ID API: タイムアウト設定（現在: 120秒）
- [ ] Supabase: 接続プールの設定

### ✅ エラーハンドリング

- [ ] エラーメッセージに機密情報が含まれていない
- [ ] 500エラー時に詳細なスタックトレースが表示されない
- [ ] try-catchで適切にエラーをキャッチしている

---

## フロントエンド セキュリティ

### ✅ XSS対策

- [ ] ユーザー入力が適切にエスケープされている（Reactのデフォルト動作）
- [ ] `dangerouslySetInnerHTML`を使用していない

### ✅ CORS設定

- [ ] 本番環境で適切なCORS設定がされている
- [ ] 許可されたオリジンのみアクセス可能

```python
# app.py
CORS(app, origins=[
    "https://your-domain.vercel.app",
    "http://localhost:5173"  # 開発環境のみ
])
```

---

## データベース セキュリティ

### ✅ SQLインジェクション対策

- [ ] Supabase SDKを使用（パラメータ化されたクエリ）
- [ ] 生のSQLクエリを使用していない

### ✅ インデックス

- [ ] 頻繁にクエリされるカラムにインデックスが設定されている
- [ ] `09_performance_indexes.sql`が実行済み

---

## 本番環境の設定

### ✅ デプロイ設定

- [ ] 本番環境でDEBUGモードが無効
- [ ] ログレベルが適切（INFOまたはWARNING）
- [ ] HTTPSが有効（Vercel/Railwayは自動）

### ✅ バックアップ

- [ ] Supabaseの自動バックアップが有効
- [ ] 重要なデータの定期バックアップ設定

---

## 監視とログ

### ✅ エラー監視

- [ ] エラーログが適切に記録されている
- [ ] 重要なエラーがアラート設定されている（オプション）

### ✅ パフォーマンス監視

- [ ] APIレスポンス時間の監視
- [ ] データベースクエリのパフォーマンス監視

---

## セキュリティテスト

### ✅ 手動テスト

- [ ] 他のユーザーのデータにアクセスできないことを確認
- [ ] 管理者権限が正しく機能することを確認
- [ ] APIエンドポイントが認証なしでアクセスできないことを確認

### ✅ 自動テスト（オプション）

- [ ] ユニットテスト
- [ ] 統合テスト
- [ ] E2Eテスト

---

## コンプライアンス

### ✅ 利用規約・プライバシーポリシー

- [ ] 利用規約の作成（必要に応じて）
- [ ] プライバシーポリシーの作成（個人情報を扱う場合）
- [ ] GDPRコンプライアンス（EU圏でのサービス提供時）

---

## 緊急時対応

### ✅ インシデント対応計画

- [ ] セキュリティインシデント発生時の連絡先
- [ ] データ漏洩時の対応手順
- [ ] システム停止時の復旧手順

---

## チェック完了

すべての項目にチェックが入ったら、本番環境デプロイの準備が整っています。

**チェック実施日**: _______________
**チェック実施者**: _______________
**承認者**: _______________
